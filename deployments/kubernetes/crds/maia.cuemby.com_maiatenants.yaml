apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: maiatenants.maia.cuemby.com
  annotations:
    controller-gen.kubebuilder.io/version: v0.14.0
spec:
  group: maia.cuemby.com
  names:
    kind: MaiaTenant
    listKind: MaiaTenantList
    plural: maiatenants
    singular: maiatenant
    shortNames:
      - mt
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Instance
          type: string
          jsonPath: .spec.instanceRef.name
        - name: Status
          type: string
          jsonPath: .status.phase
        - name: Plan
          type: string
          jsonPath: .spec.plan
        - name: Memories
          type: integer
          jsonPath: .status.memoryCount
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          type: object
          description: MaiaTenant defines a tenant within a MAIA instance
          properties:
            apiVersion:
              type: string
            kind:
              type: string
            metadata:
              type: object
            spec:
              type: object
              description: MaiaTenantSpec defines the desired state of MaiaTenant
              required:
                - instanceRef
              properties:
                instanceRef:
                  type: object
                  description: Reference to the MaiaInstance this tenant belongs to
                  required:
                    - name
                  properties:
                    name:
                      type: string
                    namespace:
                      type: string
                      description: Namespace of the MaiaInstance (defaults to same namespace)
                displayName:
                  type: string
                  description: Human-readable display name
                plan:
                  type: string
                  enum: ["free", "starter", "professional", "enterprise"]
                  default: "free"
                  description: Tenant plan level
                quotas:
                  type: object
                  description: Resource quotas for the tenant
                  properties:
                    maxMemories:
                      type: integer
                      minimum: 0
                      description: Maximum number of memories (0 = unlimited)
                    maxStorageBytes:
                      type: integer
                      format: int64
                      minimum: 0
                      description: Maximum storage in bytes (0 = unlimited)
                    maxNamespaces:
                      type: integer
                      minimum: 1
                      default: 10
                      description: Maximum number of namespaces
                    requestsPerMinute:
                      type: integer
                      minimum: 0
                      description: Rate limit - requests per minute (0 = unlimited)
                    requestsPerDay:
                      type: integer
                      minimum: 0
                      description: Rate limit - requests per day (0 = unlimited)
                config:
                  type: object
                  description: Tenant-specific configuration
                  properties:
                    defaultTokenBudget:
                      type: integer
                      default: 4000
                    maxTokenBudget:
                      type: integer
                      default: 16000
                    allowedEmbeddingModels:
                      type: array
                      items:
                        type: string
                    features:
                      type: object
                      description: Feature flags for this tenant
                      properties:
                        inference:
                          type: boolean
                          default: false
                        vectorSearch:
                          type: boolean
                          default: true
                        fullTextSearch:
                          type: boolean
                          default: true
                        contextAssembly:
                          type: boolean
                          default: true
                apiKeys:
                  type: array
                  description: API keys for this tenant (created via secrets)
                  items:
                    type: object
                    required:
                      - name
                      - secretRef
                    properties:
                      name:
                        type: string
                        description: API key name
                      secretRef:
                        type: object
                        description: Reference to secret containing the API key
                        required:
                          - name
                        properties:
                          name:
                            type: string
                          key:
                            type: string
                            default: "api-key"
                      scopes:
                        type: array
                        items:
                          type: string
                          enum: ["*", "read", "write", "delete", "admin", "context", "inference", "search", "stats"]
                        default: ["read", "write"]
                      expiresAt:
                        type: string
                        format: date-time
                        description: Optional expiration time
                suspended:
                  type: boolean
                  default: false
                  description: Whether the tenant is suspended
                suspendReason:
                  type: string
                  description: Reason for suspension
            status:
              type: object
              description: MaiaTenantStatus defines the observed state of MaiaTenant
              properties:
                phase:
                  type: string
                  enum: ["Pending", "Active", "Suspended", "Failed"]
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                        enum: ["True", "False", "Unknown"]
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
                    required:
                      - type
                      - status
                tenantId:
                  type: string
                  description: The actual tenant ID in MAIA
                memoryCount:
                  type: integer
                namespaceCount:
                  type: integer
                storageUsed:
                  type: integer
                  format: int64
                quotaUsage:
                  type: object
                  description: Current quota usage percentages
                  properties:
                    memories:
                      type: number
                      format: float
                    storage:
                      type: number
                      format: float
                    requestsPerMinute:
                      type: number
                      format: float
                    requestsPerDay:
                      type: number
                      format: float
                apiKeyCount:
                  type: integer
                lastActivity:
                  type: string
                  format: date-time
                createdAt:
                  type: string
                  format: date-time
          required:
            - spec
